# 小红书排版工具 - 技术文档

## 1. 模板样式对比

### 1.1 容器样式 (.red-image-preview)

| 模板 | 背景色/渐变 | Padding | 备注 |
|------|-------------|--------|------|
| 默认主题 | `#1c1c1e` | `30px 12px 14px 12px` | 深色背景 |
| 优雅 | `linear-gradient(135deg, #667eea 0%, #764ba2 100%)` | `30px 12px 14px 12px` | 紫色渐变 |
| 赛博 | `linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%)` | `30px 12px 14px 12px` | 深紫渐变 |
| 森林 | `linear-gradient(135deg, #134e5e 0%, #71b280 100%)` | `30px 12px 14px 12px` | 绿色渐变 |
| 海洋 | `linear-gradient(135deg, #1a2980 0%, #26d0ce 100%)` | `30px 12px 14px 12px` | 蓝色渐变 |
| 樱花 | `linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)` | `30px 12px 14px 12px` | 粉橙渐变 |
| 极简科技 | `#faf8f5` | `30px 12px 14px 12px` | 浅色背景 |
| 深邃工程 | `#0d1117` | `30px 12px 14px 12px` | GitHub 深色 |
| 结构主义 | `#f7f7f7` + 网格背景 | `30px 12px 14px 12px` | 20px 网格 |

### 1.2 标题样式

#### H1 标题

| 模板 | 字号 | 字重 | 颜色 | 特殊样式 |
|------|------|------|------|----------|
| 默认 | 1.6em | 700 | `#f2f2f7` | - |
| 优雅 | 1.6em | 700 | `#ffffff` | - |
| 赛博 | 1.6em | 700 | `#00ff88` | 发光效果 |
| 森林 | 1.6em | 700 | `#ffffff` | - |
| 海洋 | 1.6em | 700 | `#ffffff` | - |
| 樱花 | 1.6em | 700 | `#8b4a5a` | - |
| 极简科技 | 1.6em | 800 | `#111` | 左边框 8px |
| 深邃工程 | 1.8em | 700 | `#58a6ff` | 下边框，等宽字体 |
| 结构主义 | 2em | 900 | `#000` | 上下边框 3px，居中 |

#### H2 标题

| 模板 | 字号 | 字重 | 颜色 | 特殊样式 |
|------|------|------|------|----------|
| 默认 | 1.4em | 600 | `#f2f2f7` | - |
| 优雅 | 1.4em | 600 | `#ffffff` | - |
| 赛博 | 1.4em | 600 | `#00ff88` | - |
| 森林 | 1.4em | 600 | `#ffffff` | - |
| 海洋 | 1.4em | 600 | `#ffffff` | - |
| 樱花 | 1.4em | 600 | `#8b5a5a` | - |
| 极简科技 | 1.5em | 700 | `#111` | 左边框 6px |
| 深邃工程 | 1.4em | 600 | `#7ee787` | 等宽字体 |
| 结构主义 | 1.4em | 700 | `#000` | 下边框 1px |

#### H3 标题

| 模板 | 字号 | 字重 | 颜色 | 特殊样式 |
|------|------|------|------|----------|
| 默认 | 1.2em | 600 | `#f2f2f7` | - |
| 极简科技 | 1.2em | 600 | `#111` | 左边框 4px |
| 深邃工程 | 1.2em | 600 | `#ff7b72` | 等宽字体 |
| 结构主义 | 1.2em | 700 | `#333` | - |

### 1.3 正文样式

| 模板 | 行高 | 颜色 | 字体 |
|------|------|------|------|
| 默认 | 1.8 | `#f2f2f7` | 继承 |
| 优雅 | 1.8 | `rgba(255,255,255,0.95)` | 继承 |
| 赛博 | 1.8 | `#e0e0e0` | 继承 |
| 森林 | 1.8 | `rgba(255,255,255,0.95)` | 继承 |
| 海洋 | 1.8 | `rgba(255,255,255,0.95)` | 继承 |
| 樱花 | 1.8 | `#5a4a4a` | 继承 |
| 极简科技 | 1.7 | `#333333` | 系统字体 |
| 深邃工程 | 1.8 | `#c9d1d9` | 系统字体 |
| 结构主义 | 1.7 | `#333` | 宋体 |

### 1.4 强调样式

| 模板 | Strong 颜色 | Em 样式 |
|------|------------|---------|
| 默认 | `#0A84FF` | 灰色背景 |
| 优雅 | `#ffd700` (金色) | 无 |
| 赛博 | `#ff00ff` (品红) | 无 |
| 森林 | `#a8e063` | 无 |
| 海洋 | `#7dd3fc` | 无 |
| 樱花 | `#d4748a` | 无 |
| 极简科技 | `#0041C2` | 无 |
| 深邃工程 | `#79c0ff` | 无 |
| 结构主义 | `#000` | 下划线 |

### 1.5 代码样式

| 模板 | 代码块背景 | 行内代码背景 | 代码颜色 |
|------|------------|--------------|----------|
| 默认 | `#2c2c2e` | `#2c2c2e` | `#ff6b6b` |
| 优雅 | `rgba(0,0,0,0.2)` | `rgba(0,0,0,0.2)` | `#ffd700` |
| 赛博 | `rgba(0,255,136,0.1)` | `rgba(0,255,136,0.1)` | `#00ff88` |
| 森林 | `rgba(0,0,0,0.2)` | `rgba(0,0,0,0.2)` | `#a8e063` |
| 海洋 | `rgba(0,0,0,0.2)` | `rgba(0,0,0,0.2)` | `#7dd3fc` |
| 樱花 | `rgba(255,255,255,0.5)` | `rgba(255,255,255,0.5)` | `#d4748a` |
| 极简科技 | `#f4f4f5` | `#f4f4f5` | `#0041C2` |
| 深邃工程 | `#161b22` | `rgba(110,118,129,0.4)` | `#ff7b72` |
| 结构主义 | `#fff` | `#eee` | `#000` |

### 1.6 引用样式

| 模板 | 边框颜色 | 内边距 | 文字颜色 |
|------|----------|--------|----------|
| 默认 | `#0A84FF` (3px) | 16px | `#f2f2f7` |
| 优雅 | `#ffd700` (3px) | 16px | `rgba(255,255,255,0.9)` |
| 赛博 | `#ff00ff` (3px) | 16px | `#e0e0e0` |
| 森林 | `#a8e063` (3px) | 16px | `rgba(255,255,255,0.9)` |
| 海洋 | `#7dd3fc` (3px) | 16px | `rgba(255,255,255,0.9)` |
| 樱花 | `#d4748a` (3px) | 16px | `#5a4a4a` |
| 极简科技 | `#000` (4px) | 20px | `#555` (斜体) |
| 深邃工程 | `#30363d` (3px) | 16px | `#8b949e` |
| 结构主义 | `#000` (4px) | 16px | `#000` (白底) |

### 1.7 图片样式

| 模板 | 圆角 | 阴影 | 边框 | 最大高度 |
|------|------|------|------|----------|
| 默认 | 12px | - | - | 400px |
| 优雅 | 12px | 有 | - | 400px |
| 赛博 | 8px | - | `#00ff8833` | 400px |
| 森林 | 12px | - | - | 400px |
| 海洋 | 12px | - | - | 400px |
| 樱花 | 12px | 有 | - | 400px |
| 极简科技 | 12px | - | `#eee` | 400px |
| 深邃工程 | 6px | - | `#30363d` | 400px |
| 结构主义 | 0 | - | 无 | 400px |

---

## 2. 页面切分规则

### 2.1 规则类型

| 规则 | 值 | 描述 |
|------|-----|------|
| 不分割 | `none` | 所有内容从上到下连续排版，不按标题分割 |
| 一级标题 | `h1` | 按 `#` 一级标题分割内容 |
| 二级标题 | `h2` | 按 `##` 二级标题分割内容 |
| 一级+二级标题 | `h1,h2` | 按 `#` 和 `##` 标题都分割 |

### 2.2 各规则的行为

#### 不分割 (`none`)

```
输入 Markdown:
# 标题1
内容1
## 标题2
内容2

输出: 1 个 section (包含所有内容)
- section[0]: # 标题1, 内容1, ## 标题2, 内容2
```

#### 一级标题 (`h1`)

```
输入 Markdown:
开头内容
# 标题1
内容1
## 标题2
内容2
# 标题3
内容3

输出: 4 个 sections
- section[0]: 开头内容
- section[1]: # 标题1, 内容1, ## 标题2, 内容2
- section[2]: # 标题3, 内容3
```

#### 二级标题 (`h2`)

```
输入 Markdown:
开头内容
## 标题A
内容A
### 标题B
内容B

输出: 1 个 section (如果没有 h2)
- 提示: 请使用二级标题(##)来分割内容
```

#### 一级+二级标题 (`h1,h2`)

```
输入 Markdown:
开头内容
# 标题1
内容1
## 标题2
内容2
# 标题3
内容3

输出: 4 个 sections
- section[0]: 开头内容
- section[1]: # 标题1, 内容1
- section[2]: ## 标题2, 内容2
- section[3]: # 标题3, 内容3
```

### 2.3 数据结构

每个 section 的数据属性：

| 属性 | 描述 |
|------|------|
| `dataset.index` | section 的索引 |
| `dataset.splitMode` | 切分模式 (`'none'` 表示不分割) |
| `class="red-content-section"` | section 的基础类 |
| `class="red-section-active"` | 当前显示的 section (只有一个) |

---

## 3. 分页逻辑

### 3.1 分页触发时机

分页在 `handleOverflowPagination()` 函数中执行，触发条件：

1. **初始分页**：Markdown 转换后，每个 section 的内容可能超出一页高度
2. **字号变更**：用户调整字号后，需要重新计算分页

### 3.2 分页高度计算

```
MAX_CONTENT_HEIGHT = 容器高度(720px) - paddingTop - paddingBottom
```

| 主题 | paddingTop | paddingBottom | MAX_CONTENT_HEIGHT |
|------|------------|---------------|---------------------|
| 大多数主题 | 30px | 14px | 676px |
| 结构主义 | 30px | 14px | 676px |

### 3.3 分页流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    handleOverflowPagination                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  遍历每个 section                                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1. 检查 splitMode                                   │  │
│  │    - 不分割模式: 标题作为普通内容保留               │  │
│  │    - 标题分割模式: 排除标题，每个分页复制标题       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 2. 获取标题元素 (仅标题分割模式)                     │  │
│  │    heading = section.querySelector('h1, h2, h3')      │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 3. 获取内容元素                                      │  │
│  │    - 不分割: 保留所有元素                            │  │
│  │    - 标题分割: 排除 H1/H2/H3                         │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 4. 创建测量容器 (隐藏，用于高度计算)                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  逐个添加元素到测量容器，检测高度                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 添加元素 → 测量高度                                  │  │
│  │    │                                                │  │
│  │    ▼                                                │  │
│  │  高度 > MAX_CONTENT_HEIGHT ?                         │  │
│  │    │                                                │  │
│  │    ├─ 是 → 触发分页                                 │  │
│  │    │    - 保存当前页                                │  │
│  │    │    - 重置测量容器                              │  │
│  │    │    - 添加标题 (标题分割模式)                   │  │
│  │    │    - 当前元素放入新页                          │  │
│  │    │                                                │  │
│  │    └─ 否 → 继续添加元素                            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  过滤空页，重建 DOM                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1. 过滤空白内容的页面                                │  │
│  │ 2. 如果只有一页 → 保留原 section                    │  │
│  │ 3. 如果多页 → 创建新 sections                        │  │
│  │    - 每个新页添加标题 (标题分割模式)                 │  │
│  │    - 继承 splitMode 属性                             │  │
│  │ 4. 移除原 section                                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  返回总 section 数                                          │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 分页关键代码逻辑

**标题处理：**
```javascript
// 标题分割模式：每个分页都复制标题
if (headingClone) {
    measureContainer.appendChild(headingClone.cloneNode(true))
}

// 不分割模式：标题作为普通内容，不特殊处理
```

**图片处理：**
```javascript
// 显式复制图片尺寸，防止克隆节点高度为0
if (element.tagName === 'IMG') {
    elemClone.style.width = getComputedStyle(element).width
    elemClone.style.height = getComputedStyle(element).height
    elemClone.style.maxHeight = '400px'
}
```

**超大元素处理：**
```javascript
// 单个元素超出高度时，限制图片最大高度
if (singleElemHeight > MAX_CONTENT_HEIGHT) {
    const availableHeight = MAX_CONTENT_HEIGHT - headingHeight - 20
    targetImg.style.maxHeight = `${availableHeight}px`
}
```

---

## 4. 字号切换流程

### 4.1 用户操作

用户点击 `+` 或 `-` 按钮调整字号，范围：12px - 30px

### 4.2 调用链

```
用户点击 +/- 按钮
    │
    ▼
changeFontSize(delta)
    │
    ├─ 更新 fontSizeValue.textContent
    ├─ updateSettings({ fontSize: newSize })
    │
    ▼
handleRefresh()  // 触发刷新以重新分页
    │
    ▼
handleFileSelect(currentFilePath, true)  // keepPage=true
    │
    ├─ convertMarkdown(content)  // 重新生成 HTML
    ├─ applyCurrentTemplate()    // 应用模板
    ├─ reapplyFontSettings()     // 应用字号
    │
    ▼
handleOverflowPagination()      // 重新计算分页
    │
    ├─ 如果分页数变化 → 重新应用模板样式
    │
    ▼
updateNavigationState()          // 更新导航状态
```

### 4.3 字号应用逻辑

**CSS 变量：**
```javascript
imagePreview.style.setProperty('--content-font-size', `${fontSize}px`)
```

**直接应用：**
```javascript
imagePreview.querySelectorAll('p, li, td, th').forEach(el => {
    el.style.fontSize = `${fontSize}px`
})
```

**为什么需要重新分页？**

字号变化会影响：
1. 每行文字的高度
2. 段落的总体高度
3. 内容是否超出单页

因此必须重新运行 `handleOverflowPagination()` 计算分页。

### 4.4 分页后重新应用样式

```javascript
if (newTotalSections > 0) {
    totalSections = newTotalSections
    // 分页后重新应用模板样式
    await applyCurrentTemplate(templateId)
    reapplyFontSettings()
}
```

因为 `handleOverflowPagination` 重新创建了 DOM 元素，新元素丢失了模板样式，需要重新应用。

---

## 5. DOM 结构

### 5.1 完整结构

```
.red-preview-container (固定 432px × 720px)
└── .red-image-preview
    └── .red-preview-content
        └── .red-content-container
            ├── .red-content-section[data-index="0"][data-split-mode="none"].red-section-active
            ├── .red-content-section[data-index="1"] (隐藏)
            └── .red-content-section[data-index="2"] (隐藏)
```

### 5.2 显示控制

```css
.red-content-section {
    display: none;  /* 默认隐藏 */
}

.red-content-section.red-section-active {
    display: block;  /* 只有 active 的显示 */
}
```

### 5.3 导航状态

| 变量 | 描述 |
|------|------|
| `currentSectionIndex` | 当前显示的 section 索引 |
| `totalSections` | 总 section 数 |
| `prevBtn.disabled` | `currentSectionIndex === 0` |
| `nextBtn.disabled` | `currentSectionIndex === totalSections - 1` |
